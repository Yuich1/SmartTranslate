let isKira=!1;const FORMATION_ACC_COEF=[1,1.2,1,1.2,1.2,1.2],FORMATION_AVO_COEF=[1,1,1.1,1.2,1.3,1],FORMATION_DAMAGE_COEF=[1,.8,.7,.75,.6,.5],ENGAGEMENT_DAMAGE_COEF=[1.2,1,.8,.6];let cap=170;$((function(){$("#kira").on("click",(function(){const button=$("#kira");isKira=!isKira,isKira?(button.attr("class","btn btn-default btn-sm kira"),button.html("キラを消す")):(button.attr("class","btn btn-default btn-sm no-kira"),button.html("キラを付ける")),getResultData(),this.blur()})),$(".cap").on("input",(function(){cap=parseInt($(".cap").val()),console.log(cap),getResultData()})),$(".myfleet .power").on("input",(function(){getResultData()})),$(".myfleet .bomb").on("input",(function(){getResultData()})),$(".myfleet .torp").on("input",(function(){getResultData()})),$(".myfleet .item_accuracy").on("input",(function(){getResultData()})),$(".myfleet .lv").on("input",(function(){const f=$(".myfleet .lv");f.val(Math.max(f.val(),1)),f.val(Math.min(f.val(),175)),getResultData()})),$(".myfleet .luck").on("input",(function(){const f=$(".myfleet .luck");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .armor").on("input",(function(){const f=$(".enemy .armor");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .hp").on("input",(function(){const f=$(".enemy .hp");f.val(Math.max(f.val(),1)),getResultData()})),$(".enemy .luck").on("input",(function(){const f=$(".enemy .luck");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .avoidance").on("input",(function(){const f=$(".enemy .avoidance");f.val(Math.max(f.val(),0)),getResultData()})),$(".my-formation, .enemy-formation, .critical").on("input",(function(){getResultData()})),$(".engagement").on("input",(function(){setSauin(1!=$(".engagement").val().split(",").length),getResultData()}))}));const getHitTerm=(formation_coef,support_const,cond_conef,luck,lv,equip_hit)=>Math.floor(cond_conef*formation_coef*Math.floor(support_const+1.5*Math.sqrt(luck)+2*Math.sqrt(lv)+equip_hit)),getAvoidanceTerm=(avoidance,luck)=>{const formation_coef=FORMATION_AVO_COEF[$(".enemy-formation").val()];let avoidanceTerm=formation_coef*(avoidance+Math.sqrt(2*luck));return avoidanceTerm=Math.floor(avoidanceTerm),avoidanceTerm>=65?Math.floor(55+2*Math.sqrt(avoidanceTerm-65)):avoidanceTerm>=40?Math.floor(40+3*Math.sqrt(avoidanceTerm-40)):avoidanceTerm},getFinalAccuracy=(hitTerm,avoidanceTerm)=>{let finalAccuracy=hitTerm-avoidanceTerm+1;return Math.min(finalAccuracy,97)},getAttack=(attack,formationDamageCoef,engagementDamageCoef)=>((attack=attack*formationDamageCoef*engagementDamageCoef)>cap&&(attack=cap+Math.sqrt(attack-cap)),Math.floor(attack)),getResultData=()=>{let sink=0,taiha=0,tyuha=0,shoha=0,fine=0;const hp=$(".enemy .hp").val(),formationDamageCoef=FORMATION_DAMAGE_COEF[parseInt($(".my-formation").val())],engagementDamageCoefs=$(".engagement").val().split(","),criticalFlag=parseFloat($(".critical").val()),support_const=64;let cond_coef=1,formation_coef=FORMATION_ACC_COEF[parseInt($(".my-formation").val())],luck=0,lv=1;lv=$(".myfleet .lv").val(),luck=$(".myfleet .luck").val(),isKira&&(cond_coef=1.2);const item_accuracy=parseInt($(".myfleet .item_accuracy").val());let hitTerm=getHitTerm(formation_coef,64,cond_coef,luck,lv,item_accuracy),avoidanceTerm=getAvoidanceTerm(parseInt($(".enemy .avoidance").val()),parseInt($(".enemy .luck").val())),finalAccuracy=getFinalAccuracy(hitTerm,avoidanceTerm),power=parseInt($(".myfleet .power").val());const bomb=parseInt($(".myfleet .bomb").val()),torp=parseInt($(".myfleet .torp").val()),armor=parseInt($(".enemy .armor").val()),criticalCoef=[1,1.5];bomb>0||torp>0?power=Math.floor(1.5*(power+torp+Math.floor(1.3*bomb)-1))+55:power+=4,$(".myfleet .support_power").text(power);let cappedAttack=0,criticalTerm=0,fineProb=0,shohaProb=0,tyuhaProb=0,taihaProb=0,sinkProb=0;const engagementRates={noSaiun:[.15,.45,.3,.1],saiun:[.15,.45,.4,0]};for(let j=0;len=engagementDamageCoefs.length,j<len;j++){const engagementDamageCoef=parseFloat(engagementDamageCoefs[j]);cappedAttack=Math.floor(getAttack(power,formationDamageCoef,engagementDamageCoef));const trialNumber=100;criticalTerm=2==criticalFlag?100:0,3==criticalFlag&&(criticalTerm=Math.floor(Math.sqrt(finalAccuracy))+1);const criticalTerms=[100-criticalTerm,criticalTerm];for(let i=0;i<2;i++){sink=0,taiha=0,tyuha=0,shoha=0,fine=0;for(let index=0;index<=trialNumber;index++){const randArmor=index/trialNumber*(armor-1),finalAttack=Math.floor(cappedAttack*criticalCoef[i]),damage=Math.floor(finalAttack-(.7*armor+.6*randArmor));damage>=hp?sink++:damage>=.75*hp?taiha++:damage>=.5*hp?tyuha++:damage>=.25*hp?shoha++:fine++}let engagementRate=1;if(engagementDamageCoefs.length>1&&document.getElementById("saiunCheck")){const isSauin=document.getElementById("saiunCheck").checked;engagementRate=isSauin?engagementRates.saiun[j]:engagementRates.noSaiun[j]}fineProb+=fine*criticalTerms[i]/(trialNumber+1)*engagementRate,shohaProb+=shoha*criticalTerms[i]/(trialNumber+1)*engagementRate,tyuhaProb+=tyuha*criticalTerms[i]/(trialNumber+1)*engagementRate,taihaProb+=taiha*criticalTerms[i]/(trialNumber+1)*engagementRate,sinkProb+=sink*criticalTerms[i]/(trialNumber+1)*engagementRate}}$(".result-left").html(`命中項 ${hitTerm}<br>\n        基本回避項 ${0==avoidanceTerm?avoidanceTerm+"<span style='color: #dc143c'>(不明)</span>":avoidanceTerm}<br>\n        最終命中率 ${finalAccuracy}%<br>\n        ${1==engagementDamageCoefs.length?`最終攻撃力 ${3==criticalFlag?`(CL1) ${Math.floor(1*cappedAttack)}, (CL2) ${Math.floor(1.5*cappedAttack)}`:Math.floor(cappedAttack*criticalCoef[criticalFlag-1])}${cappedAttack>=151?"(キャップ到達)":""}<br>\n        クリティカル率 (CL1) ${100-criticalTerm}%, (CL2) ${criticalTerm}%<br></br>`:`クリティカル率 (CL1) ${100-criticalTerm}%, (CL2) ${criticalTerm}%<br></br>`}\n        <br>\n        <div class="sub-title">命中時撃破率</div>\n        撃沈 ${round(sinkProb,1)}%<br>\n        大破 ${round(taihaProb,1)}%<br>\n        中破 ${round(tyuhaProb,1)}%<br>\n        小破 ${round(shohaProb,1)}%<br>\n        小破未満 ${Math.round(fineProb,1)}%`),$(".result-right").html(`<div class="sub-title">命中込み撃沈率</div>\n  撃沈 ${round(sinkProb*finalAccuracy/100,1)}%<br>\n  大破 ${round(taihaProb*finalAccuracy/100,1)}%<br>\n  中破 ${round(tyuhaProb*finalAccuracy/100,1)}%<br>\n  小破 ${round(shohaProb*finalAccuracy/100,1)}%<br>\n  小破未満 ${round(fineProb*finalAccuracy/100,1)}%<br>\n  miss ${100-finalAccuracy}%<br>`),$(".result .progress-bar-miss").attr("style",`width:${100-finalAccuracy}%`),$(".result .progress-bar-miss").html(`miss ${Math.floor(10*(100-finalAccuracy))/10}%`),$(".result .progress-bar-fine").attr("style",`width:${fineProb*finalAccuracy/100}%`),$(".result .progress-bar-fine").html(`小破未満 ${round(fineProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-shoha").attr("style",`width:${shohaProb*finalAccuracy/100}%`),$(".result .progress-bar-shoha").html(`小破 ${round(shohaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-tyuha").attr("style",`width:${tyuhaProb*finalAccuracy/100}%`),$(".result .progress-bar-tyuha").html(`中破 ${round(tyuhaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-taiha").attr("style",`width:${taihaProb*finalAccuracy/100}%`),$(".result .progress-bar-taiha").html(`大破 ${round(taihaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-sink").attr("style",`width:${sinkProb*finalAccuracy/100}%`),$(".result .progress-bar-sink").html(`撃沈 ${round(sinkProb*finalAccuracy/100,1)}%`)};function round(number,precision){let shift=function(number,precision,reverseShift){reverseShift&&(precision=-precision);let numArray=(""+number).split("e");return+(numArray[0]+"e"+(numArray[1]?+numArray[1]+precision:precision))};return shift(Math.round(shift(number,precision,!1)),precision,!0)}const setSauin=isActive=>{if(isActive){const form=$("<input>",{type:"checkbox",class:"form-check-input",id:"saiunCheck",onclick:"getResultData()"}),label=$("<label>",{class:"form-check-label",text:"彩雲",for:"saiunCheck"}),div=$("<div>",{class:"form-check"});div.append(form).append(label),$(".saiunSet").append(div)}else $(".saiunSet").children().remove()};